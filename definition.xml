<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
	<ModulePrefs title="Group Status Panel" 
		description="Graph group level element status"/> 
  <Content type="html">
<![CDATA[ 

	  <html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
		<title>Group Status</title>
		<link href="/styles/uptime.css" type="text/css" rel="stylesheet" />

		<script type="text/javascript" src="/ajax/jquery.js?v=7.2.0.0"></script>
		<script type="text/javascript" src="/ajax/highcharts/highcharts.js?v=7.2.0.0"></script>

		<script type="text/javascript" src="__UPTIME_GADGET_BASE__/uptime.GroupCurrentStatusBarChart.js"></script>
		<script type="text/javascript" src="__UPTIME_GADGET_BASE__/uptime.GroupCurrentStatusPieChart.js"></script>
		<script type="text/javascript" src="__UPTIME_GADGET_BASE__/uptime.Helper.js"></script>
		<script type="text/javascript" src="__UPTIME_GADGET_BASE__/uptimeApi.js"></script>

	</head>

	<body>
			 
	

	<div id="widgetSettings">
		Select Element Group:
		<form id="widgetOptions">
			<div id = "availableGroups"></div>
			<input type="checkbox" id="includeSubgroup" value"true" checked>Include Subgroup<br/>
			Chart Type:
			<input type="radio" checked id="pieChartType" name="chartType" value="pieChartType"> Pie
			<input type="radio" id="barChartType" name="chartType" value="barChartType"> Bar
			<br/>
			Status Type:
			<input type="radio" id="hostStatusType" name="statusType" value="hostStatusType"> Host
			<input type="radio" checked id="monitorStatusType" name="statusType" value="monitorStatusType"> Monitor
			<br/>
			<br/>
			Refresh Interval:
			<select id="refreshInterval" value="1">
				<option value="0">Off</option>
				<option value="0.25">15 sec</option>
				<option value="0.5">30 sec</option>
				<option value="1">1 min</option>
				<option value="2">2 min</option>
				<option value="2">3 min</option>
				<option value="5" selected>5 min</option>
			</select>
			<br/>
			<br/>
			<input id="saveSettings" type="button" value="Save">
			<input id="cancelSave" type="button" value="Cancel">
		</form>
	</div>

	<div id = "widgetChart" style="border:1px solid;"></div>	
	<div id ="lastRefresh"></div>
	<div id="statusBar" style="display:none; width:100%; font-weight:bold;font-size:larger; ">Backend Call Status</div>
	
	<script>
        $(function() {
			var uptime_api = new uptimeApi();
			var myChart = null;
			
			$("#widgetSettings").hide();
			$("#widgetChart").hide();

			function showEditPanel(){
				if (myChart) {
					myChart.stopTimer();
					myChart = null;
				}
				$("#widgetSettings").show();
				$("#widgetChart").hide();	
				$("#lastRefresh").hide();
			}

			$("#saveSettings").click(function(){
				var chartTypeId = $("#widgetOptions input[name=chartType]:radio:checked").val();
				var groupId = $('#elementGroupId').find(":selected").val();
				var groupName = $('#elementGroupId').find(":selected").text();
				var statusTypeId = $("#widgetOptions input[name=statusType]:radio:checked").val();
				var refreshInterval = $("#widgetOptions #refreshInterval").val();
				var includeSubgroup = $("#widgetOptions #includeSubgroup").is(":checked");
//console.log("saveSettings includeSubgroup="+includeSubgroup);
				//save group name for now, just for demo purposes
				var settings = {'groupId':groupId, 'chartType':chartTypeId, 'groupName':groupName, 'statusType':statusTypeId, 'refreshInterval':refreshInterval,'includeSubgroup':includeSubgroup};
				uptimeGadget.saveSettings(settings, onGoodSave, onBadAjax);
			});

			$("#cancelSave").click(function(){
				$("#widgetChart").show();
				$("#lastRefresh").show();
				$("#widgetSettings").hide();
			});

			
			function displayPanel(settings){
				$("#widgetChart").show();
				$("#widgetSettings").hide();				
//console.log("displayPanel: includeSubgroup="+settings.includeSubgroup);
				displayChart(settings.chartType, settings.groupId, settings.groupName, settings.statusType, settings.refreshInterval, settings.includeSubgroup);
			}
			
			function groupSort(arg1, arg2) {
				return naturalSort(arg1.name, arg2.name);
			}

			function goodLoad(settings){
				var statusBar = $("#statusBar");

				uptime_api.getGroups("", function(groups) {
					statusBar.css("color", "green");
					statusBar.text("Loaded and READY!");
					statusBar.show().fadeOut(2000);
					var optionsValues = '<select id="elementGroupId">';
					groups.sort(groupSort);
					$.each(groups, function(index,group) {
						optionsValues += '<option value="' + group.id + '">' + group.name + '</option>';
					});
					optionsValues += '</select>';
					$('#availableGroups').html(optionsValues);
					
					if (settings){
						//update hidden edit panel with settings
						$("#elementGroupId").val(settings.groupId);
						$("#"+settings.chartType).prop("checked", true); 
						$("#"+settings.statusType).prop("checked", true); 
						$("#refreshInterval").val(settings.refreshInterval);
						$("#includeSubgroup").val(settings.includeSubgroup);
						
						displayPanel(settings);					
					}
					else {
						showEditPanel();
					}
				},function(jqXHR, textStatus, errorThrown) {
						var statusBar = $(statusBarDivId);
						statusBar.css("color", "red");
						statusBar.text("Can't connect to the up.time API.");
						statusBar.show();
				});
				
			}

			function onGoodSave(savedSettings){				
				var statusBar = $("#statusBar");

				statusBar.css("color", "green");
				statusBar.text("Updated settings!");
				statusBar.show().fadeOut(2000);

				displayPanel(savedSettings);
			}
			
			function onBadAjax(errorObject){
				var statusBar = $("#statusBar");
				statusBar.css("color", "red");
											   
				statusBar.text(errorObject.code+": "+errorObject.description);
				statusBar.show().fadeOut(2000);
			}

			function displayChart(chartType, groupId, groupName, statusType, refreshInterval, includeSubgroup){
			//console.log("displayCharts: includeSubgroup="+includeSubgroup);
				// stop any existing timers in the charts (for when we save and change settings)
				if (myChart) {
					myChart.stopTimer();
					myChart = null;
				}
					
				if (chartType  == "pieChartType"){
					myChart = new UPTIME.GroupCurrentStatusPieChart({chartDivId: "widgetChart", entityGroupId:groupId, entityGroupName:groupName, statusType:statusType, refreshInterval:refreshInterval, refreshIntervalDivId:"lastRefresh", statusBarDivId:"statusBar", uptime_api:uptime_api,includeSubgroup:includeSubgroup});
				}
				else {
					myChart = new UPTIME.GroupCurrentStatusBarChart({chartDivId: "widgetChart", entityGroupId:groupId, entityGroupName:groupName, statusType:statusType, refreshInterval:refreshInterval, refreshIntervalDivId:"lastRefresh", statusBarDivId:"statusBar", uptime_api:uptime_api,includeSubgroup:includeSubgroup});
				}
			}

			uptimeGadget.registerOnEditHandler(showEditPanel);
			uptimeGadget.registerOnLoadHandler(function(){uptimeGadget.loadSettings(goodLoad, onBadAjax);});
			//uptimeGadget.registerOnUploadFile(function (e){});
		});				  
    </script>
	
	
	</body>
</html>

















]]>
  </Content> 
</Module>
